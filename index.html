<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registos de Serviço</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f8fafc;
      color: #1e293b;
    }
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(90deg, #5dbb63, #153c63);
      color: white;
      padding: 12px 20px;
    }
    header img {
      height: 40px;
      width: 40px;
    }
    header h1 {
      font-size: 1.2rem;
      margin: 0;
    }
    main {
      padding: 20px;
      max-width: 1200px;
      margin: auto;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
    }
    select {
      padding: 8px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      min-width: 180px;
    }
    #count {
      margin-top: 8px;
      font-weight: 500;
      color: #153c63;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #e2e8f0;
      text-align: left;
    }
    th {
      background: #e6f4ea;
      color: #153c63;
      font-weight: 600;
    }
    tr:hover {
      background: #f1f5f9;
    }
    #spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
    #spinner img {
      width: 60px;
      height: 60px;
      animation: spin 1.5s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo">
    <h1>Registos de Serviço</h1>
  </header>
  <main>
    <div class="filters">
      <select id="motoristaFilter">
        <option value="">Todos os Motoristas</option>
      </select>
      <select id="mesFilter">
        <option value="">Todos os Meses</option>
      </select>
    </div>
    <div id="count"></div>
    <div id="spinner"><img src="logo.png" alt="A carregar..."></div>
    <div id="data"></div>
  </main>

  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbzz0EoiT8BFkbj0Mnq3Y1s3uSkYQ2TMU2sBVj93Y8DRMQ-pOry7XPI-vkJRE7Rd5Qyq/exec";

    let allData = [];

    // Calcular mês de processamento (16/mm -> 15/mm+1)
    function getMesProcessamento(dateStr) {
      const meses = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
      const d = new Date(dateStr);
      if (isNaN(d)) return "Inválido";
      let mes = d.getMonth();
      let ano = String(d.getFullYear()).slice(-2);
      let dia = d.getDate();

      if (dia >= 16) {
        // vai para o mês seguinte
        mes = (mes + 1) % 12;
        if (mes === 0) ano = String(d.getFullYear()+1).slice(-2);
      }
      return meses[mes] + " " + ano;
    }

    async function loadData() {
      try {
        const res = await fetch(endpoint);
        const json = await res.json();
        allData = json.data.map(r => ({
          Data: r["Data"],
          Viatura: r["Viatura"],
          Motorista: r["Motorista"],
          Cliente: r["Cliente"],
          HoraEntrada: r["Hora Entrada"],
          KmEntrada: r["Km Entrada"],
          HoraSaida: r["Hora Saída"],
          KmSaida: r["Km Saída"],
          MesProc: getMesProcessamento(r["Data"])
        }));

        populateFilters();
        render();
      } catch (e) {
        document.getElementById("data").innerHTML = "<p>Erro ao carregar dados.</p>";
      } finally {
        document.getElementById("spinner").style.display = "none";
      }
    }

    function populateFilters() {
      const motoristas = [...new Set(allData.map(r => r.Motorista).filter(Boolean))].sort();
      const meses = [...new Set(allData.map(r => r.MesProc))].sort((a,b)=> {
        const [ma,aa]=a.split(" ");
        const [mb,ab]=b.split(" ");
        return new Date("1 "+ma+" 20"+aa) - new Date("1 "+mb+" 20"+ab);
      });

      const mSel = document.getElementById("motoristaFilter");
      motoristas.forEach(m=>{
        const opt=document.createElement("option");
        opt.value=m; opt.textContent=m;
        mSel.appendChild(opt);
      });

      const mesSel = document.getElementById("mesFilter");
      meses.forEach(m=>{
        const opt=document.createElement("option");
        opt.value=m; opt.textContent=m;
        mesSel.appendChild(opt);
      });

      mSel.addEventListener("change", render);
      mesSel.addEventListener("change", render);
    }

    function render() {
      const motoristaVal = document.getElementById("motoristaFilter").value;
      const mesVal = document.getElementById("mesFilter").value;

      let data = [...allData];
      if (motoristaVal) data = data.filter(r=>r.Motorista===motoristaVal);
      if (mesVal) data = data.filter(r=>r.MesProc===mesVal);

      // ordenar por Data e Motorista
      data.sort((a,b)=>{
        const da=new Date(a.Data), db=new Date(b.Data);
        if (da-db!==0) return da-db;
        return a.Motorista.localeCompare(b.Motorista);
      });

      document.getElementById("count").textContent = "Total " + data.length;

      let html = "<table><thead><tr>";
      ["Data","Viatura","Motorista","Cliente","HoraEntrada","KmEntrada","HoraSaida","KmSaida"]
        .forEach(c=>{
          html += "<th>"+c.replace(/([A-Z])/g," $1")+"</th>";
        });
      html += "</tr></thead><tbody>";

      data.forEach(r=>{
        html += "<tr>"+
          "<td>"+r.Data+"</td>"+
          "<td>"+r.Viatura+"</td>"+
          "<td>"+r.Motorista+"</td>"+
          "<td>"+r.Cliente+"</td>"+
          "<td>"+r.HoraEntrada+"</td>"+
          "<td>"+r.KmEntrada+"</td>"+
          "<td>"+r.HoraSaida+"</td>"+
          "<td>"+r.KmSaida+"</td>"+
        "</tr>";
      });

      html += "</tbody></table>";
      document.getElementById("data").innerHTML = html;
    }

    loadData();
  </script>
</body>
</html>
